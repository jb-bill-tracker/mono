<script lang="ts">
  import Header from "$lib/components/header/header.svelte";
  import { Accordion, AccordionItem, Step, Stepper } from "@skeletonlabs/skeleton";
  import { PlusIcon, HomeIcon } from "lucide-svelte";
  export let data;

  const today = new Date();

    /**
   * UPCOMING < 5
   * COMING SOON < 10
   * PAID - status===paid
   * PAST - status !== paid && dueDate < currentDate
   */

  let billName = '';
  let dueDate = 1;
  let householdId = '';  

</script>

<svelte:head>
  <title>Dashboard</title>
</svelte:head>

<Header class="mt-4 mb-4">
  Dashboard
  <svelte:fragment slot="actions">
    <button
      class="btn variant-ghost-primary btn-sm flex gap-1"
      on:click={() => {
        /** @type {HTMLDialogElement} */
        const el = document.getElementById("add-bill-ui");
        if (!el) return;
        el.showModal();
      }}><PlusIcon size="1.1em" />New Bill</button>
    <button class='btn variant-ghost-primary btn-sm flex gap-2'>
      <HomeIcon size='1.1em' />
      New Household
    </button>
  </svelte:fragment>
</Header>

<dialog class="bg-surface-800 w-10/12 text-white p-4 rounded backdrop:bg-zinc-900/40" id="add-bill-ui">
  <form action="?/addBill" method="post" >
    <Stepper on:complete={e => {
      const el = document.getElementById('add-bill-ui');
      if(!el) return;
      const fd = new FormData();
      console.info(householdId, billName, dueDate);
      fd.append('household-id', householdId);
      fd.append('bill-name', billName);
      fd.append('due-date', dueDate.toString());
      fetch('?/addBill', {
        method: 'post',
        body: fd
      }).then(console.info).catch(console.error);
      [householdId, billName, dueDate] = ['','', 1];

      el.close();
    }}>
      <Step>
        <svelte:fragment slot="header">Bill Information</svelte:fragment>
        <input
          class="px-2 input"
          type="text"
          name="bill-name"
          placeholder="Name of the bill"
          required
          bind:value={billName}
        />
        <input bind:value={dueDate} name="dueDate" class="px-2 input" placeholder="1" type="number" min="1" max="31" required />
      </Step>
      <Step>
        <svelte:fragment slot="header">Household</svelte:fragment>
        <select bind:value={householdId} name="household-id" class="input p-3">
          {#each data.households as household}
            <option value={household.id}>
              {household.name} &ndash; {household.householdCount} member(s)
            </option>
          {:else}
            <option disabled>
              No households
            </option>
          {/each}
        </select>
      </Step>
    </Stepper>
  </form>
</dialog>


<div class="">
  <Accordion class="flex flex-col gap-2">
    <AccordionItem open class="card variant-soft-surface">
      <svelte:fragment slot="summary">
        <Header tag="h3" color="secondary">
          Past Due
        </Header>
      </svelte:fragment>
      <svelte:fragment slot="content">
        <section class="p-4">
          List of past due bills here
        </section>
      </svelte:fragment>
    </AccordionItem>
    <AccordionItem open class="card variant-soft-surface">
      <svelte:fragment slot="summary">
        <Header tag="h3" color="secondary">
          Upcoming
        </Header>
      </svelte:fragment>
      <svelte:fragment slot="content">
        <div class="flex flex-col gap-4">
          {#each data.groupings.upcoming as { bills, household }}
            <div class="card variant-ghost-primary">
              <Header tag="h4" class="card-header">
                {bills.billName} due on {bills.dueDate}
              </Header>
              <section class="p-4">
                Other relevant information
              </section>
  
            </div>
            {:else}
            No Upcoming bills
          {/each}
        </div>
      </svelte:fragment>
    </AccordionItem>
    <AccordionItem open={data.groupings.comingSoon.length > 0} class="card variant-soft-surface">
      <svelte:fragment slot="summary">
        <Header tag="h3" color="secondary">
          Coming Soon
        </Header>
      </svelte:fragment>
      <svelte:fragment slot="content">
        <div class="flex flex-col gap-2">
          {#each data.groupings.comingSoon as {bills, household}}
            {bills.billName}
          {:else}
            <p>No bills coming soon</p>
          {/each}
        </div>
      </svelte:fragment>
    </AccordionItem>
    <AccordionItem open={data.groupings.paid.length > 0} class="card variant-soft-surface">
      <svelte:fragment slot="summary">
        <Header tag="h3" color="secondary">
          Paid
        </Header>
      </svelte:fragment>
      <svelte:fragment slot="content">
        <div class="grid grid-cols-3 gap-32">
          {#each data.groupings.paid as {bills, household}}
            <div class="card variant-filled-primary">
              <header class="card-header p-4">
                {bills.billName} - due on {bills.dueDate}
              </header>
            </div>
          {/each}
        </div>
      </svelte:fragment>
    </AccordionItem>
  </Accordion>
</div>